<modification>
	<id>smscab.ru newsletter</id>
	<version>0.4.2</version>
	<vqmver>0.4.2</vqmver>
	<author>smscab.ru</author>

	<file name="admin/controller/sale/contact.php">
		<operation>
			<search position="after">
			<![CDATA[$emails[] = $result['email'];]]>
			</search>
			<add>
			<![CDATA[$telephones[] = $result['telephone'];]]>
			</add>
		</operation>
		<operation>
			<search position="after">
			<![CDATA[$emails[] = $customer_info['email'];]]>
			</search>
			<add>
			<![CDATA[$telephones[] = $customer_info['telephone'];]]>
			</add>
		</operation>
		<operation>
			<search position="after">
			<![CDATA[$emails[] = $affiliate_info['email'];]]>
			</search>
			<add>
			<![CDATA[$telephones[] = $affiliate_info['telephone'];]]>
			</add>
		</operation>

		<operation>
			<search position="before" offset="1">
			<![CDATA[case 'customer_group':]]>
			</search>
			<add>
			<![CDATA[
            
            $query = $this->db->query("SELECT email, telephone FROM " . DB_PREFIX . "order WHERE 1");
						foreach ($query->rows as $result) {
							$emails[] = $result['email'];
							$telephones[] = $result['telephone'];
						}	
            	
            $emails = array_unique($emails); $telephones = array_unique($telephones);
            $email_total = max(count($emails), count($telephones));
            	
      ]]>
			</add>
		</operation>


		<operation>
  	<search position="before"><![CDATA[foreach ($emails as $email) {]]></search>
  	<add>
  		<![CDATA[
          if($this->request->post['newsletter_sms'] && trim($this->request->post['newsletter_sms_text']) != "") {
              $options = array(
                  'to'       => $this->config->get('config_sms_to'),
                  'copy'     => implode(",", $telephones),
                  'from'     => $this->config->get('config_sms_from'),
                  'login' => $this->config->get('config_sms_gate_username'),
                  'password' => $this->config->get('config_sms_gate_password'),
                  'message'  => trim($this->request->post['newsletter_sms_text']),
              );
              
              if(count($telephones) == 1) {
                  $options['to'] = $telephones['0'];
                  $options['copy'] = '';
              }
              
              $this->load->library('sms');
              $sms = new Sms($this->config->get('config_sms_gatename'), $options);
              if($this->config->get('config_sms_alert') == 1 && ($this->config->get('config_sms_gatename') == "epochta" || $this->config->get('config_sms_gatename') == "smscab" || $this->config->get('config_sms_gatename') == "smscabNew")) $sms->send();
          }
          
          if($this->request->post['newsletter_email'])
  		]]>
  	</add>
		</operation>
	</file>

	
  <file name="admin/view/template/sale/contact.tpl">
  	<operation>
  	<search position="after"><![CDATA[<td><textarea name="message"></textarea></td>]]></search>
  	<add>
  		<![CDATA[
            </tr>
          <tr>
            <td>Отправить новость по почте (e-mail)</td>
            <td><input type="checkbox" name="newsletter_email" value="1" /></td>
          </tr>
          <tr>
            <td>Отправить новость по sms</td>
            <td><input type="checkbox" name="newsletter_sms" value="1" /></td>
          </tr>
            <tr>
              <td>Текст смс новости</td>
              <td><textarea name="newsletter_sms_text" cols="70" rows="10"></textarea></td>
  		]]>
  	</add>
  	</operation>
  	
  	<operation>
  	<search position="after"><![CDATA[function send(url) {]]></search>
  	<add>
  		<![CDATA[ 
	$('input[name=\'newsletter_email\']').attr('value', encodeURIComponent($('input[name=\'newsletter_email\']').attr('checked') ? 1 : 0));
	$('input[name=\'newsletter_sms\']').attr('value', encodeURIComponent($('input[name=\'newsletter_sms\']').attr('checked') ? 1 : 0));
      ]]>
  	</add>
  	</operation>
  </file>

	
</modification>
